#!/usr/bin/env bash
set -e

echo "Starting Railway deployment..."

# Check environment variables
echo "Environment check:"
echo "PORT: $PORT"
echo "RAILS_ENV: $RAILS_ENV"
echo "DATABASE_URL: ${DATABASE_URL:0:20}..."

# Check if database is available
echo "Checking database connection..."
if bundle exec rails runner "puts 'Database connected successfully'"; then
  echo "✅ Database connection OK"
else
  echo "❌ Database connection failed"
  exit 1
fi

# Run database migrations
echo "Running database migrations..."
bundle exec rails db:migrate

# Start the server
echo "Starting Rails server on port $PORT..."
exec bundle exec rails server -p $PORT -e production -b 0.0.0.0
